.container
  %br
  %br
  .row
    .col-sm-8
      - unless @counseling_session.counselor_id == current_user.counselor.id if current_user.counselor.present?
        .counselor_preview_wrapper
          .row
            .col-xs-4.col-md-3
              .counselor_image_wrapper
                -if @counseling_session.counselor.photo.present?
                  = image_tag @counseling_session.counselor.photo_url(:medium), :class => "counselor_image"
                -else
                  = image_tag "default-avatar.png", :class => "counselor_image"
            .col-xs-6.col-md-7

              .counselor_name_wrapper
                %h1.counselor_name
                  = @counseling_session.counselor.user.name

              %p.session_timeline
                = @counseling_session.start_datetime.in_time_zone.strftime("%B %e, %Y at %l:%M%P -")
                = @counseling_session.estimated_endtime.in_time_zone.strftime("%l:%M%P")

    .col-sm-4
      - if @counseling_session.counselor_id == current_user.counselor.id if current_user.counselor.present?
        %p.text-right.text-muted
          %em
            = current_user.counselor.session_count_with_client(@counseling_session.client_id).ordinalize
            session with
            = @counseling_session.client.name
      - else
        %p.text-right.text-muted
          %em
            = current_user.session_count_with_counselor(@counseling_session.counselor.id).ordinalize
            session with
            = @counseling_session.counselor.user.name
      
      %p.text-right
        #countdown_clock.text-right

      %br

  #video_wrapper
    #userDiv.hidden-xs

    #connectedToDiv

    #awaiting_connection
      %p
        Your video call will begin once you allow use of camera, microphone, and the other party joins.

  %br
  .text-muted.text-center
    Make sure to allow Camera and Microphone in your browser.

  -# #clock

  - unless @counseling_session.counselor_id == current_user.counselor.id if current_user.counselor.present?

    %hr
    - if @rating.present?
      %br
      .text-center
        = render "ratings/modal"
    - else
      .text-center
        %em
          You have already submitted a rating for this session.

  .text-center
    = link_to "Exit Session", user_dashboard_path, :class => "btn text-danger"

%script{:src => "//static.opentok.com/webrtc/v2.2/js/opentok.min.js"}

:javascript

  var Time = Date.now();

  $('#countdown_clock').countdown("#{@counseling_session.start_datetime.strftime("%Y/%m/%d %T")}", function(event) {
    var totalHours = event.offset.totalDays * 24 + event.offset.hours;
    $(this).html(event.strftime(totalHours + ' hr %M min %S sec'));

    if ( event.strftime(totalHours + ' hr %M min %S sec').toString() == "0 hr 00 min 00 sec") {
      $(this).html("Session is LIVE");
    }
    
  });

  //  var updateClock = function() {
  //      function pad(n) {
  //          return (n < 10) ? '0' + n : n;
  //      }
  //
  //      var now = new Date();
  //      var s = pad(now.getUTCHours()) + ':' +
  //              pad(now.getUTCMinutes()) + ':' +
  //              pad(now.getUTCSeconds());
  //
  //      $('#clock').html(s);
  //
  //      var delay = 1000 - (now % 1000);
  //      setTimeout(updateClock, delay);
  //      console.log(s)
  //  };
  //
  //  updateClock();

  var apiKey = '45208992';
  var sessionId = "#{@counseling_session.opentok_session_id}"; 
  var token = "#{@token}";
  
  var session = OT.initSession(apiKey, sessionId);

  session.on({ 
      streamCreated: function(event) { 
        $("#awaiting_connection").hide();
        session.subscribe(event.stream, 'connectedToDiv', {insertMode: 'append', width:'100%', height:600}); 
        $("#connectedToDiv .OT_subscriber").css({"margin-left": "auto", "margin-right": "auto"});
      }
  });
  var publisher = OT.initPublisher("userDiv")

  session.connect(token, function(error) {
    if (error) {
      console.log(error.message);
      $("#awaiting_connection").show();
    } else {
      session.publish(publisher, {width:50, height:25});
    }
  });
}
